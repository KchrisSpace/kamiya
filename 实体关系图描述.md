# Kamiya 花卉商城实体关系图（ER 图）描述

## 实体列表及属性

### 1. 用户实体 (users)

**实体描述**: 存储系统所有用户（包括管理员和普通用户）的基础信息

**属性列表**:

- **id** (主键, String) - 用户唯一标识
- **username** (唯一, String) - 登录用户名
- **password** (String) - 密码
- **role** (String) - 用户角色（admin/user）
- **email** (String) - 邮箱地址
- **phone** (String) - 手机号码
- **email_verified** (Boolean) - 邮箱验证状态
- **phone_verified** (Boolean) - 手机验证状态
- **account_status** (String) - 账户状态
- **user_info** (Object) - 用户扩展信息对象
  - nickname (String) - 用户昵称
  - avatar (String) - 头像 URL
- **created_at** (String) - 创建时间
- **updated_at** (String) - 更新时间

**关系**:

- 1 对多 → 订单实体 (normal_orders)
- 1 对多 → 商品评论实体 (product_comments)
- 1 对多 → 购物车实体 (cart)
- 1 对多 → 定制实体 (custom)
- 1 对多 → 反馈实体 (feedback)

---

### 2. 商品实体 (products_list)

**实体描述**: 存储所有商品的基本信息、价格、库存等数据

**属性列表**:

- **id** (主键, String) - 商品唯一标识
- **title** (String) - 商品名称
- **main_category** (String) - 主分类（热销/上新/特价出售）
- **category** (String) - 商品类别（单品/冷品/暖品/套餐）
- **price_info** (Object) - 价格信息对象
  - original_price (Number) - 原价
  - current_price (Number/String) - 当前价格
  - hasDiscount (Boolean) - 是否有折扣
  - discount (Number) - 折扣百分比
- **stock** (Number) - 库存数量
- **description** (String) - 商品描述
- **images** (String) - 商品主图 URL
- **promotion** (Object) - 促销信息对象
  - keywords (Array) - 关键词数组
  - material (String) - 材料说明
  - is_hot (Boolean) - 是否热门
- **sales** (Number) - 销量
- **score** (Number) - 评分
- **status** (String) - 商品状态（1:上架, 0:下架）
- **views** (Number) - 浏览量
- **favorites** (Number) - 收藏数
- **created_at** (String) - 创建时间
- **updated_at** (String) - 更新时间

**关系**:

- 1 对多 → 商品评论实体 (product_comments)
- 1 对多 → 购物车实体 (cart)
- 1 对多 → 订单项 (normal_orders.items)

---

### 3. 商品评论实体 (product_comments)

**实体描述**: 存储用户对商品的评价信息，包括评分、内容、图片等

**属性列表**:

- **id** (主键, String) - 评论唯一标识
- **product_id** (外键, String) - 关联商品 ID → products_list.id
- **user_id** (外键, String) - 关联用户 ID → users.id
- **user_name** (String) - 用户昵称（快照）
- **avatar** (String) - 用户头像 URL（快照）
- **content** (String) - 评论内容
- **rating** (Number) - 评分（1-5 星）
- **tags** (Array) - 评价标签数组
- **images** (Array) - 评价图片 URL 数组
- **useful_count** (Number) - 有用数
- **is_visible** (Boolean) - 是否可见
- **is_audited** (Boolean) - 是否已审核
- **reply** (String) - 商家回复内容
- **reply_time** (String) - 商家回复时间
- **created_at** (String) - 创建时间
- **updated_at** (String) - 更新时间

**关系**:

- 多对 1 → 商品实体 (products_list) [通过 product_id]
- 多对 1 → 用户实体 (users) [通过 user_id]

---

### 4. 订单实体 (normal_orders)

**实体描述**: 存储用户的订单信息，包括商品列表、价格、状态等

**属性列表**:

- **id** (主键, Number) - 订单唯一标识
- **user_id** (外键, String) - 关联用户 ID → users.id
- **items** (Array) - 订单商品项数组
  - product_id (String) - 商品 ID
  - product_name (String) - 商品名称（快照）
  - quantity (Number) - 购买数量
  - single_price (Number) - 单价（快照）
- **total_price** (Number) - 订单总价
- **shipping_fee** (Number) - 配送费用
- **delivery_time** (String) - 取餐时间
- **consignee** (String) - 收货人姓名
- **phone** (String) - 联系电话
- **remark** (String) - 订单备注
- **status** (String) - 订单状态
- **payment_method** (String) - 支付方式
- **payment_time** (String) - 支付时间
- **shipped_time** (String) - 出餐时间
- **completed_time** (String) - 完成时间
- **communications** (Array) - 订单沟通记录数组
  - role (String) - 角色（customer/admin）
  - text (String) - 消息内容
  - images (Array) - 消息图片数组
  - created_at (String) - 消息时间
- **created_at** (String) - 创建时间
- **updated_at** (String) - 更新时间

**关系**:

- 多对 1 → 用户实体 (users) [通过 user_id]
- 订单项中包含商品信息（通过 items.product_id 关联，但采用快照方式存储）

---

### 5. 购物车实体 (cart)

**实体描述**: 存储用户购物车中的商品信息

**属性列表**:

- **id** (主键, String) - 购物车项唯一标识
- **user_id** (外键, String) - 关联用户 ID → users.id
- **product_id** (外键, String) - 关联商品 ID → products_list.id
- **quantity** (Number) - 商品数量
- **created_at** (String) - 创建时间

**关系**:

- 多对 1 → 用户实体 (users) [通过 user_id]
- 多对 1 → 商品实体 (products_list) [通过 product_id]

**约束**: 同一用户同一商品只能有一条记录（唯一约束：user_id + product_id）

---

### 6. 轮播图实体 (carousel)

**实体描述**: 存储首页轮播图信息

**属性列表**:

- **id** (主键, String) - 轮播图唯一标识
- **img** (String) - 轮播图 URL 路径

**关系**: 无（独立实体）

---

### 7. 定制实体 (custom)

**实体描述**: 存储用户提交的定制订单信息

**属性列表**:

- **id** (主键, String) - 定制订单唯一标识
- **user_id** (外键, String) - 关联用户 ID → users.id
- **custom_img** (String) - 定制图片 URL
- **email** (String) - 联系邮箱
- **phone** (String) - 联系电话
- **custom_message** (String) - 定制需求描述
- **created_at** (String) - 创建时间
- **updated_at** (String) - 更新时间

**关系**:

- 多对 1 → 用户实体 (users) [通过 user_id]

---

### 8. 反馈实体 (feedback)

**实体描述**: 存储用户提交的意见反馈信息

**属性列表**:

- **id** (主键, String) - 反馈唯一标识
- **user_id** (外键, String, 可为空) - 关联用户 ID → users.id（支持匿名反馈）
- **name** (String) - 反馈人姓名
- **email** (String) - 反馈人邮箱
- **phone** (String) - 反馈人电话
- **feedback_message** (String) - 反馈内容
- **status** (String) - 处理状态（pending/processed）
- **created_at** (String) - 创建时间
- **updated_at** (String) - 更新时间

**关系**:

- 多对 1 → 用户实体 (users) [通过 user_id，可选关系]

---

## 实体关系汇总

### 关系类型说明

1. **用户 (users) → 订单 (normal_orders)**

   - 关系类型: 1 对多 (1:N)
   - 关系描述: 一个用户可以拥有多个订单
   - 外键: normal_orders.user_id → users.id

2. **用户 (users) → 商品评论 (product_comments)**

   - 关系类型: 1 对多 (1:N)
   - 关系描述: 一个用户可以发表多条评论
   - 外键: product_comments.user_id → users.id

3. **用户 (users) → 购物车 (cart)**

   - 关系类型: 1 对多 (1:N)
   - 关系描述: 一个用户可以拥有多个购物车项
   - 外键: cart.user_id → users.id

4. **用户 (users) → 定制 (custom)**

   - 关系类型: 1 对多 (1:N)
   - 关系描述: 一个用户可以提交多个定制订单
   - 外键: custom.user_id → users.id

5. **用户 (users) → 反馈 (feedback)**

   - 关系类型: 1 对多 (1:N)
   - 关系描述: 一个用户可以提交多条反馈（支持匿名）
   - 外键: feedback.user_id → users.id（可为空）

6. **商品 (products_list) → 商品评论 (product_comments)**

   - 关系类型: 1 对多 (1:N)
   - 关系描述: 一个商品可以有多条评论
   - 外键: product_comments.product_id → products_list.id

7. **商品 (products_list) → 购物车 (cart)**

   - 关系类型: 1 对多 (1:N)
   - 关系描述: 一个商品可以被多个用户加入购物车
   - 外键: cart.product_id → products_list.id

8. **商品 (products_list) → 订单项 (normal_orders.items)**
   - 关系类型: 1 对多 (1:N)
   - 关系描述: 一个商品可以出现在多个订单中（通过订单项）
   - 注意: 订单项中存储的是商品快照信息，不直接使用外键关联

---

## ER 图绘制建议

### 实体表示方法

- 使用矩形框表示实体
- 实体名称写在矩形框顶部
- 属性列表写在矩形框内
- 主键属性用下划线标记（如：`__id__`）
- 外键属性用斜体标记（如：`*user_id*`）

### 关系表示方法

- 使用菱形表示关系
- 关系类型标注在连线上（1、N、M 等）
- 外键关系用箭头指向被引用实体

### 关键关系图

```
用户 (users)
  ├── 1 ──< N ── 订单 (normal_orders)
  ├── 1 ──< N ── 商品评论 (product_comments)
  ├── 1 ──< N ── 购物车 (cart)
  ├── 1 ──< N ── 定制 (custom)
  └── 1 ──< N ── 反馈 (feedback)

商品 (products_list)
  ├── 1 ──< N ── 商品评论 (product_comments)
  └── 1 ──< N ── 购物车 (cart)

订单 (normal_orders)
  └── N ──> 1 ── 用户 (users)
```

---

## 特殊说明

1. **订单项快照**: 订单中的商品信息（product_name, single_price）采用快照方式存储，不直接关联商品表，确保历史订单数据不受商品信息变更影响。

2. **匿名反馈**: 反馈表中的 user_id 可以为空，支持匿名用户提交反馈。

3. **购物车唯一约束**: 同一用户同一商品在购物车中只能有一条记录，通过 (user_id, product_id) 唯一约束实现。

4. **软删除**: 评论实体使用 is_visible 字段控制可见性，而非物理删除。

---

**文档版本**: v1.0  
**最后更新**: 2025-12-28
